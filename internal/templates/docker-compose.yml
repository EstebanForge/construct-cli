services:
  construct-box:
    build:
      context: .
      dockerfile: Dockerfile
    image: construct-box:latest
    pull_policy: never

    # User is set dynamically in docker-compose.override.yml:
    # - Linux/Podman: runs as construct user (1000:1000) - host-side fixes handle permissions
    # - macOS/Docker: runs as root, then drops to construct via gosu in entrypoint

    # Set a fixed hostname for a cleaner prompt (e.g., construct@sandbox instead of construct@99ab3b5f37d1)
    hostname: sandbox

    # Interactive TTY session
    stdin_open: true
    tty: true

    # Persistent volumes for agent installations
    volumes:
      - ${PWD}:${CONSTRUCT_PROJECT_PATH}                                      # Current project
      - ~/.config/construct-cli/home:/home/construct    # Entire home directory (configs, caches, etc.)
      - construct-packages:/home/linuxbrew/.linuxbrew   # Homebrew packages & agents

    # Environment variables
    # NOTE: Keep this PATH list in sync with:
    # - internal/env/env.go (BuildConstructPath)
    # - internal/templates/entrypoint.sh
    # - internal/templates/Dockerfile
    environment:
      - HOME=/home/construct
      - CONSTRUCT_PROJECT_PATH=${CONSTRUCT_PROJECT_PATH}
      - CONSTRUCT_HOST_UID=${CONSTRUCT_HOST_UID}
      - CONSTRUCT_HOST_GID=${CONSTRUCT_HOST_GID}
      - CGO_ENABLED=1
      - PATH=/home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/sbin:/home/construct/.local/bin:/home/construct/.npm-global/bin:/home/construct/.cargo/bin:/home/construct/.bun/bin:/home/construct/.asdf/bin:/home/construct/.asdf/shims:/home/construct/.local/share/mise/bin:/home/construct/.local/share/mise/shims:/home/construct/.volta/bin:/home/construct/.local/share/pnpm:/home/construct/.yarn/bin:/home/construct/.config/yarn/global/node_modules/.bin:/home/construct/go/bin:/home/construct/.composer/vendor/bin:/home/construct/.config/composer/vendor/bin:/home/construct/.nix-profile/bin:/nix/var/nix/profiles/default/bin:/home/construct/.phpbrew/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      - LD_LIBRARY_PATH=/home/linuxbrew/.linuxbrew/lib

    # Network mode (overridden by config.toml [network] section)
    # network_mode: bridge  # permissive (default)
    # network_mode: none    # airgapped

    # Working directory
    working_dir: ${CONSTRUCT_PROJECT_PATH}

    # Named volumes for persistent agent and packages storage
    # CRITICAL: volumes must be owned by construct user (not root)
    # This prevents brew/npm permission errors after updates
volumes:
  construct-packages:
