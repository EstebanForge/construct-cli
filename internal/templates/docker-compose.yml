services:
  construct-box:
    build:
      context: .
      dockerfile: Dockerfile
    image: construct-box:latest
    pull_policy: never

    # CRITICAL: Run as construct user (not root)
    # This prevents brew/npm from creating root-owned files
    # user: "construct:construct" -> Removed to allow entrypoint to fix permissions first

    # Set a fixed hostname for a cleaner prompt (e.g., construct@sandbox instead of construct@99ab3b5f37d1)
    hostname: sandbox

    # Interactive TTY session
    stdin_open: true
    tty: true

    # Persistent volumes for agent installations
    volumes:
      - ${PWD}:${CONSTRUCT_PROJECT_PATH:-/workspace}                                      # Current project
      - ~/.config/construct-cli/home:/home/construct    # Entire home directory (configs, caches, etc.)
      - construct-packages:/home/linuxbrew/.linuxbrew   # Homebrew packages & agents

    # Environment variables
    environment:
      - HOME=/home/construct
      - CONSTRUCT_PROJECT_PATH=${CONSTRUCT_PROJECT_PATH:-/workspace}
      - PATH=/home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/sbin:/home/construct/.local/bin:/home/construct/.local/share/uv/bin:/home/construct/.local/share/pipx/bin:/home/construct/.npm-global/bin:/home/construct/.composer/vendor/bin:/home/construct/.local/share/composer/vendor/bin:${PATH}

    # Network mode (overridden by config.toml [network] section)
    # network_mode: bridge  # permissive (default)
    # network_mode: none    # airgapped

    # Working directory
    working_dir: ${CONSTRUCT_PROJECT_PATH:-/workspace}

    # Named volumes for persistent agent and packages storage
    # CRITICAL: volumes must be owned by construct user (not root)
    # This prevents brew/npm permission errors after updates
volumes:
  construct-packages:
