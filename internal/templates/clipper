#!/bin/bash

# Clipper: A bridge script to fetch clipboard data from the Construct host

# Configuration from environment
HOST_URL="${CONSTRUCT_CLIPBOARD_URL}"
AUTH_TOKEN="${CONSTRUCT_CLIPBOARD_TOKEN}"
AGENT_NAME="${CONSTRUCT_AGENT_NAME}"

if [ -z "$HOST_URL" ]; then
    echo "Error: CONSTRUCT_CLIPBOARD_URL not set" >&2
    exit 1
fi

CALL_NAME=$(basename $0)
TARGET_MIME=""
IS_OUTPUT_MODE=false
REQUESTED_TARGETS=false
PATH_AGENT=false

FILE_PASTE_AGENTS="${CONSTRUCT_FILE_PASTE_AGENTS:-gemini,qwen,codex}"
if [[ ",$FILE_PASTE_AGENTS," == *",$AGENT_NAME,"* ]]; then
    PATH_AGENT=true
fi

# Simple arg parsing for xclip/xsel/wl-paste patterns
for arg in "$@"; do
    if [[ "$arg" == "image/png" ]]; then
        TARGET_MIME="image/png"
    fi
    if [[ "$arg" == "TARGETS" ]] || [[ "$arg" == "atoms" ]]; then
        REQUESTED_TARGETS=true
    fi
    if [[ "$arg" == "-o" ]] || [[ "$arg" == "--output" ]] || [[ "$arg" == "-p" ]] || [[ "$arg" == "--paste" ]]; then
        IS_OUTPUT_MODE=true
    fi
done

# If agent is asking for available targets, we MUST include image/png
if [[ "$REQUESTED_TARGETS" == "true" ]]; then
    # Always report supported types for the bridge
    echo "TIMESTAMP"
    echo "TARGETS"
    echo "MULTIPLE"
    echo "UTF8_STRING"
    echo "STRING"
    echo "TEXT"
    echo "image/png"
    echo "image/tiff"
    exit 0
fi

TMP_RAW="/tmp/construct-clipboard-raw.png"

fetch_image() {
    curl -s -f \
        -H "X-Construct-Clip-Token: ${AUTH_TOKEN}" \
        "${HOST_URL}/paste?type=image/png" -o "$TMP_RAW"
}

emit_image_bytes() {
    if command -v identify >/dev/null && command -v convert >/dev/null; then
        DIMENSIONS=$(identify -format "%w %h" "$TMP_RAW" 2>/dev/null || true)
        WIDTH=$(echo "$DIMENSIONS" | awk '{print $1}')
        HEIGHT=$(echo "$DIMENSIONS" | awk '{print $2}')
        if [ -n "$WIDTH" ] && [ -n "$HEIGHT" ]; then
            if [ "$WIDTH" -gt 8000 ] || [ "$HEIGHT" -gt 8000 ]; then
                convert "$TMP_RAW" -resize 8000x8000\> png:- 2>/dev/null
                return $?
            fi
        fi
    fi
    cat "$TMP_RAW"
}

emit_image_path() {
    mkdir -p .construct-clipboard 2>/dev/null
    TIMESTAMP=$(date +%s%3N)
    IMG_NAME="clipboard-${TIMESTAMP}.png"
    IMG_PATH="$(pwd)/.construct-clipboard/${IMG_NAME}"
    if cp "$TMP_RAW" "$IMG_PATH"; then
        if [ "$AGENT_NAME" = "codex" ]; then
            echo -n "${IMG_PATH}"
        else
            echo -n "@${IMG_PATH}"
        fi
        return 0
    fi
    return 1
}

# Always try image first; fall back to text if no image and no explicit image request.
if fetch_image; then
    if [[ "$PATH_AGENT" == "true" ]]; then
        emit_image_path
        exit $?
    fi
    emit_image_bytes
    exit $?
fi

if [[ "$TARGET_MIME" == "image/png" ]]; then
    exit 1
fi

# Fetch text from host
OUTPUT=$(curl -s -f \
    -H "X-Construct-Clip-Token: ${AUTH_TOKEN}" \
    "${HOST_URL}/paste?type=text/plain")

EXIT_CODE=$?

echo -n "$OUTPUT"

if [ $EXIT_CODE -eq 22 ]; then
    exit 1
fi

exit $EXIT_CODE
